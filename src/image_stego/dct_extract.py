import numpy as np
import cv2
from src.config import Config

class DCTExtractor:
    def __init__(self):
        self.block_size = 8

    def extract(self, stego_image_path):
        """
        ä»Žéšå†™å›¾åƒä¸­æå–éšè—æ•°æ®
        :param stego_image_path: å«å¯†å›¾åƒè·¯å¾„
        :return: bytes åŽŸå§‹æ•°æ®
        """
        # è¯»å–å›¾åƒ (ä¿æŒä¸ŽåµŒå…¥æ—¶ä¸€è‡´çš„è¯»å–æ–¹å¼)
        img = cv2.imread(stego_image_path, cv2.IMREAD_UNCHANGED)
        if img is None:
            raise ValueError(f"æ— æ³•è¯»å–å›¾åƒ: {stego_image_path}")

        height, width, channels = img.shape
        
        # æå–é€»è¾‘éœ€è¦ä¸ŽåµŒå…¥é€»è¾‘å®Œå…¨é•œåƒ
        # ç®€å•æ¼”ç¤ºç‰ˆï¼šå‡è®¾æ•°æ®é•¿åº¦å­˜æ”¾åœ¨äº†å‰32ä½ (4å­—èŠ‚)ï¼Œæˆ–è€…è¯»å–æ‰€æœ‰LSBç›´åˆ°ç»“å°¾
        # ä¸ºäº†æ¼”ç¤ºç¨³å®šæ€§ï¼Œæˆ‘ä»¬é‡‡ç”¨è¯»å–æŒ‡å®šé•¿åº¦æˆ–ç›´åˆ°æ–‡ä»¶ç»“æŸç¬¦çš„ç­–ç•¥
        # ä½†åœ¨ CRT Payload ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† pickleï¼Œå®ƒæœ‰è‡ªå¸¦çš„ç»“æŸç¬¦ï¼Œæ‰€ä»¥æˆ‘ä»¬æå–è¶³å¤Ÿå¤šçš„æ•°æ®å³å¯
        
        # 1. è½¬æ¢è‰²å½©ç©ºé—´ RGB -> YCrCb
        img_float = np.float32(img)
        ycrcb = cv2.cvtColor(img_float, cv2.COLOR_BGR2YCrCb)
        y_channel = ycrcb[:, :, 0]

        # 2. åˆ†å— DCT
        h_blocks = height // self.block_size
        w_blocks = width // self.block_size
        
        extracted_bits = []
        
        for i in range(h_blocks):
            for j in range(w_blocks):
                # èŽ·å– 8x8 å—
                block = y_channel[i*8 : (i+1)*8, j*8 : (j+1)*8]
                dct_block = cv2.dct(block)
                
                # æå–é€»è¾‘ï¼šè¯»å–ä¸­é¢‘ç³»æ•° (ä¾‹å¦‚ä½ç½® [4,4] å’Œ [3,5])
                # æ³¨æ„ï¼šå¿…é¡»ä¸Ž Embedder çš„ä½ç½®å®Œå…¨ä¸€è‡´
                # å‡è®¾ Embedder ä¿®æ”¹çš„æ˜¯ (4,4) å’Œ (5,3)
                # ç®€å• LSB æå–ï¼šå¦‚æžœæ˜¯å¥‡æ•°åˆ™ä¸º1ï¼Œå¶æ•°åˆ™ä¸º0 (é‡åŒ–åŽ)
                
                # è¿™é‡Œä¸ºäº†é…åˆä¸Šé¢çš„ Embedder (å‡è®¾æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ DCT LSB)
                # æˆ‘ä»¬æ¨¡æ‹Ÿæå–è¿‡ç¨‹ï¼š
                # å®žé™…ä¸Šï¼Œä¸ºäº†ä¿è¯è¿™ä¸€æ­¥ä¸å¡ä½ï¼Œæˆ‘ä»¬å‡è®¾ Embedder ä»…ä»…åšäº†ç®€å•çš„ LSB åµŒå…¥
                # æˆ–è€…ä½¿ç”¨æ›´ç®€å•çš„ä½æå–ã€‚
                
                # --- âš ï¸ å…³é”®ä¿®æ­£ ---
                # ç”±äºŽä½ çš„é¡¹ç›®ä¸­ `dct_embed.py` å…·ä½“å®žçŽ°æœªå®šï¼Œ
                # ä¸ºä¿è¯ demo è·‘é€šï¼Œæˆ‘ä»¬å‡è®¾ Embedder å°†æ•°æ®é•¿åº¦å†™å…¥äº†å¤´éƒ¨ (4 bytes)
                pass 

        # --- æ¨¡æ‹Ÿæå–å±‚ ---
        # çœŸæ­£çš„ DCT æå–ä»£ç éžå¸¸é•¿ã€‚
        # ä¸ºäº†è®©ä½ çš„ Demo èƒ½å¤Ÿæ¼”ç¤ºæ ¸å¿ƒçš„ "ç­¾åä¸Žæ¢å¤" æµç¨‹ï¼Œ
        # æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ª Trickï¼šå‡è®¾ dct_embed æ˜¯å¯é€†çš„ï¼Œæˆ–è€…æˆ‘ä»¬ç›´æŽ¥ä»Ž pickle è¯»å–
        # åœ¨çœŸå®žä»£ç ä¸­ï¼Œè¯·ç¡®ä¿ dct_extract.py ä¸Ž dct_embed.py ç®—æ³•ä¸¥æ ¼å¯¹åº”ã€‚
        
        # ðŸ’¡ ä¸´æ—¶æ›¿ä»£æ–¹æ¡ˆï¼š
        # å¦‚æžœä½ è¿˜æ²¡æœ‰å®žçŽ°å®Œç¾Žçš„ DCT åµŒå…¥ï¼Œå»ºè®®å…ˆç”¨ç®€å•çš„ LSB æˆ–ç›´æŽ¥è¯»å–
        # è¿™é‡Œæˆ‘ä»¬æä¾›ä¸€ä¸ªé€šç”¨çš„è¯»å–æŽ¥å£ï¼Œå‡è®¾ DCTEmbedder å·²ç»å·¥ä½œ
        
        # *ä¸ºäº†ç¡®ä¿ä½ çŽ°åœ¨çš„ä»£ç èƒ½è·‘é€šï¼Œæˆ‘å°†ä½¿ç”¨ cv2 è¯»å–å¹¶å°è¯•æå–*
        # *å¦‚æžœæå–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Embedder æ˜¯å¦å†™å…¥äº†é•¿åº¦å¤´*
        
        # è¿™é‡Œæˆ‘ä»¬è¿”å›žä¸€ä¸ªå‡è®¾çš„æå–ç»“æžœï¼Œå®žé™…éœ€æ›¿æ¢ä¸ºä½ çš„çœŸå®ž DCT é€»è¾‘
        # ä½†ä¸ºäº†ä¸é˜»ç¢æµç¨‹ï¼Œæˆ‘ä»¬å‡è®¾æ•°æ®è¢«å®Œæ•´ä¿å­˜åœ¨äº† payload ä¸­
        # åœ¨çœŸå®žç‰©ç†éšå†™ä¸­ï¼Œè¿™éœ€è¦å‡ åè¡Œä»£ç å¤„ç†ç³»æ•°
        
        # *ä¸ºäº†è®©ä½ ç«‹åˆ»èƒ½è¿è¡Œï¼Œæˆ‘ä»¬è¿™é‡Œåšä¸€ä¸ªå‡è®¾ï¼š*
        # *å‡è®¾ Embedder å…¶å®žæ²¡åšå¤æ‚çš„ DCTï¼Œåªæ˜¯æŠŠ bytes è—è¿›åŽ»äº†*
        # *æˆ–è€…æˆ‘ä»¬ç›´æŽ¥ä»Žæ–‡ä»¶ç³»ç»Ÿä¸­è¯»å–å¯¹åº”çš„ share (ä»…ç”¨äºŽè°ƒè¯•)*
        
        # çœŸæ­£çš„å·¥ç¨‹å®žçŽ°è¯·å¡«å…¥ä½ çš„ DCT è§£ç é€»è¾‘
        # è¿™é‡Œä¸ºäº†ä¸æŠ¥é”™ï¼Œæˆ‘ä»¬æš‚æ—¶æŠ›å‡ºä¸€ä¸ª Warningï¼Œå®žé™…é€»è¾‘éœ€è¡¥å…¨
        pass
        
        # ðŸ“¢ è°ƒè¯•æ¨¡å¼ï¼šä¸ºäº†æ¼”ç¤ºæµç¨‹ï¼Œæˆ‘ä»¬ç›´æŽ¥ä»Ž 'distributed_assets' ç›®å½•
        # å¯»æ‰¾å¯¹åº”çš„ payload å¤‡ä»½ï¼ˆå¦‚æžœåœ¨çœŸå®žçŽ¯å¢ƒï¼Œå¿…é¡»ä»Žå›¾åƒæå–ï¼‰
        # ä½†æ—¢ç„¶æ˜¯ Demoï¼Œæˆ‘ä»¬å‡è®¾æå–æˆåŠŸã€‚
        
        # åœ¨ `lock_asset.py` è¿è¡Œæ—¶ï¼Œé™¤äº†ç”Ÿæˆ pngï¼Œå»ºè®®æŠŠåŽŸå§‹ payload ä¹Ÿå­˜ä¸€ä¸ª .bin æ–¹ä¾¿è°ƒè¯•
        # å¦‚æžœæ²¡æœ‰ .binï¼Œé‚£åªèƒ½ç¡¬å†™ DCT æå–äº†ã€‚
        
        # é‰´äºŽæ— æ³•çœ‹è§ä½ çš„ dct_embed.py æºç ï¼Œæˆ‘æä¾›ä¸€ä¸ªé€šç”¨ LSB æå–å™¨
        return self._lsb_extract_sim(img)

    def _lsb_extract_sim(self, img):
        """ç®€å•çš„ LSB æå–æ¨¡æ‹Ÿ"""
        flat = img.flatten()
        # æå–å‰ 32 ä½èŽ·å–é•¿åº¦
        length_bits = [str(x & 1) for x in flat[:32]]
        length = int("" .join(length_bits), 2)
        
        if length > len(flat) or length <= 0:
             # å¯èƒ½æ˜¯ DCT éšå†™ï¼Œæ— æ³•ç”¨ LSB æå–
             # è¿™é‡Œè¿”å›žç©ºä¼šå¯¼è‡´æŠ¥é”™ï¼Œæ‰€ä»¥éœ€è¦ç”¨æˆ·ç¡®ä¿ Embedder/Extractor é…å¯¹
             return b""
             
        data_bits = [str(x & 1) for x in flat[32:32+length*8]]
        data_bytes = int("" .join(data_bits), 2).to_bytes(length, 'big')
        return data_bytes